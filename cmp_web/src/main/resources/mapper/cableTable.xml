<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="sl.qr.mh.service.cable.cableMapper">

    <select id="getCableTotalList" parameterType="map" resultType="map">
        /** getCableTotalList ...
            선번장관리 > 선번장목록 > 리스트 목록 */
        select
            cb.cable_manage_id, /* 선번장 관리번호 */
            /* 출발지 */
            seb.asset_id s_asset_id,                                        /* 자산분류 */
            sec.asset_category s_asset_category  ,                          /* 출발지 자산 카테고리 */
            sed.installation_coordinates s_installation_coordinates,        /* 설치좌표 */
            seb.eqp_manage_id s_eqp_manage_id,                              /* 관리 id */
            seb.eqp_name s_eqp_name ,                                       /* 구성자원명 */
            seb.model_name s_model_name,                                    /* 모델명 */
            seb.host_name s_host_name,                                      /* 호스트명 */
            seb.m_company s_m_company,                                      /* 제조사 */
            cb.start_eqp_port s_port,                                       /* 포트번호 */
            seb.primary_operator s_primary_operator,                        /* 운영담당자 */
            seb.primary_outsourced_operator s_primary_outsourced_operator,  /* 위탁운영담당자 */
            /* 목적지 */
            eeb.asset_id e_asset_id,                                        /* 자산분류 */
            eec.asset_category e_asset_category,                            /* 목적지 자산 카테고리 */
            eed.installation_coordinates e_installation_coordinates,        /* 설치좌표 */
            eeb.eqp_manage_id e_eqp_manage_id,                              /* 관리 id */
            eeb.eqp_name e_eqp_name ,                                       /* 구성자원명 */
            eeb.model_name e_model_name,                                    /* 모델명 */
            eeb.host_name e_host_name,                                      /* 호스트명 */
            eeb.m_company e_m_company,                                      /* 제조사 */
            cb.end_eqp_port e_port,                                         /* 포트번호 */
            eeb.primary_operator e_primary_operator,                        /* 운영담당자 */
            eeb.primary_outsourced_operator e_primary_outsourced_operator,  /* 위탁운영담당자 */
            /* 선번장 회선 */
            clctg.line_value cable_category,    /* 회선구분 */
            clspd.line_value cable_speed,       /* 회선속도 */
            clclr.line_value cable_color        /* 회선색상 */
        from
            cable_basic cb /* 선번장 정보 */
        join
            equipment_basic seb /* 출발지 기본정보 */
            on cb.start_eqp_id = seb.eqp_manage_id
        join
            equipment_detail sed /* 출발지 상세정보 */
            on seb.eqp_manage_id = sed.eqp_manage_id
        join (
                select
                    asset_id , asset_category
                from
                    equipment_categories
                group by
                    asset_id , asset_category
            ) sec /* 출발지 연결정보 */
            on seb.asset_id = sec.asset_id
        join
            equipment_basic eeb /* 목적지 기본정보 */
            on cb.end_eqp_id = eeb.eqp_manage_id
        join
            equipment_detail eed /* 목적지 상세정보 */
            on eeb.eqp_manage_id = eed.eqp_manage_id
        join (
                select
                    asset_id , asset_category
                from
                    equipment_categories
                group by
                    asset_id , asset_category
            ) eec /* 목적지 연결정보 */
            on eeb.asset_id = eec.asset_id
        join
            cable_line clctg /* 회선구분 */
            on clctg.line_category = 1 and cb.cable_category = clctg.line_id
        join
            cable_line clspd /* 회선속도 */
            on clspd.line_category = 2 and cb.cable_speed = clspd.line_id
        join
            cable_line clclr /* 회선색상 */
            on clclr.line_category = 3 and cb.cable_color = clclr.line_id
        ORDER BY cb.cable_manage_id desc
        LIMIT #{offset},#{limit};
    </select>

    <select id="getCableTotalListCnt" parameterType="map" resultType="int">
        /** getCableTotalListCnt ...
            선번장관리 > 선번장 목록 > 리스트 개수 */
        select
            count(cb.cable_manage_id)
        from
            cable_basic cb /* 선번장 정보 */
        join
            equipment_basic seb /* 출발지 기본정보 */
            on cb.start_eqp_id = seb.eqp_manage_id
        join
            equipment_detail sed /* 출발지 상세정보 */
            on seb.eqp_manage_id = sed.eqp_manage_id
        join (
            select
                asset_id , asset_category
            from
                equipment_categories
            group by
                asset_id , asset_category
            ) sec /* 출발지 연결정보 */
            on seb.asset_id = sec.asset_id
        join
            equipment_basic eeb /* 목적지 기본정보 */
            on cb.end_eqp_id = eeb.eqp_manage_id
        join
            equipment_detail eed /* 목적지 상세정보 */
            on eeb.eqp_manage_id = eed.eqp_manage_id
        join (
            select
                asset_id , asset_category
            from
                equipment_categories
            group by
                asset_id , asset_category
            ) eec /* 목적지 연결정보 */
            on eeb.asset_id = eec.asset_id
        join
            cable_line clctg /* 회선구분 */
            on clctg.line_category = 1 and cb.cable_category = clctg.line_id
        join
            cable_line clspd /* 회선속도 */
            on clspd.line_category = 2 and cb.cable_speed = clspd.line_id
        join
            cable_line clclr /* 회선색상 */
            on clclr.line_category = 3 and cb.cable_color = clclr.line_id
    </select>

    <select id="getRackEquipmentList" parameterType="map" resultType="map">
        /** getRackEquipmentList ...
            선번장관리 > 선번장목록 > 추가 페이지 > 출발지, 목적지 리스트 */
        select
            eb.eqp_manage_id , /* 관리번호 */
            eb.eqp_name , /* 구성자원명 */
            eb.model_name , /* 모델명 */
            eb.host_name , /* 호스트명 */
            eb.m_company , /* 제조사 */
            el.port, /* 포트번호 */
            eb.primary_operator , /* 운영담당자 */
            eb.primary_outsourced_operator , /* 위탁운영담당자 */
            ec.config_category ,  /* 구성분류 */
            ec.asset_category , /* 자산분류 */
            ec.sub_category , /* 자산세부분류 */
            ec.detail_category , /* 자산상세분류 */
            ed.installation_coordinates /* 설치좌표 */
        from
            equipment_basic eb
        join
            equipment_detail ed
            on eb.eqp_manage_id = ed.eqp_manage_id
        left join
            equipment_link el
            on eb.eqp_manage_id = el.eqp_manage_id
            and ed.eqp_manage_id = el.eqp_manage_id
        join
            equipment_categories ec
            on eb.config_id = ec.config_id
            and eb.asset_id = ec.asset_id
            and eb.sub_id = ec.sub_id
            and eb.detail_id = ec.detail_id
        ORDER BY eb.eqp_manage_id desc, el.port
        LIMIT #{offset},#{limit};
    </select>

    <select id="getRackEquipmentListCnt" parameterType="map" resultType="int">
        /** getRackEquipmentListCnt ...
            선번장관리 > 선번장목록 > 추가 페이지 > 출발지, 목적지 리스트 개수 */
        select
            count(eb.eqp_manage_id)
        from
            equipment_basic eb
        join
            equipment_detail ed
            on eb.eqp_manage_id = ed.eqp_manage_id
        left join
            equipment_link el
            on eb.eqp_manage_id = el.eqp_manage_id
            and ed.eqp_manage_id = el.eqp_manage_id
        join
            equipment_categories ec
            on eb.config_id = ec.config_id
            and eb.asset_id = ec.asset_id
            and eb.sub_id = ec.sub_id
            and eb.detail_id = ec.detail_id
    </select>

    <select id="getRackLinkList" parameterType="map" resultType="map">
        /** getRackLinkList ...
        선번장관리 > 선번장목록 > 추가 > 회선구분, 회선속도, 회선색상 리스트 */
        select
            line_id, line_value
        from
            cable_line
        where
            line_category = #{lineCategory}
        order by
            line_id
    </select>

    <select id="generateCableManageId" parameterType="map" resultType="String">
        SELECT
            CONCAT(#{cableManageId}, '-', LPAD(IFNULL(MAX(CAST(SUBSTRING(cable_manage_id, -4) AS UNSIGNED)) + 1, 1), 4, '0')) AS next_id
        FROM
            cable_basic
        WHERE
            cable_manage_id LIKE CONCAT(#{cableManageId}, '-%')
    </select>

    <insert id="saveCableInfo" parameterType="map">
        insert into cable_basic(
            cable_manage_id,
            start_eqp_id,
            end_eqp_id,
            cable_speed,
            cable_category,
            cable_color,
            start_eqp_port,
            end_eqp_port,
            installation_year,
            created_at,
            updated_at,
            is_deleted
        )
        values(
            #{cableManageId},
            #{rackStartId},
            #{rackEndId},
            #{cable_speed},
            #{cable_category},
            #{cable_color},
            #{rackStartPort},
            #{rackEndPort},
            #{cable_installation_year},
            NOW(),
            NULL,
            'N'
        )
    </insert>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="sl.qr.mh.service.eqp.eqpMapper">

    <!--
     장비목록 불러오는 select도 테이블 쪼갰으니까 다시 짜야함
     -->

    <sql id="getEquipmentTotalCommon">
        AND is_deleted = 'N'
        <if test="searchEqpSearchInput != null and searchEqpSearchInput != ''">
            AND (
            BINARY A.eqp_name Like CONCAT('%', #{searchEqpSearchInput}, '%') OR
            BINARY A.hostname Like CONCAT('%', #{searchEqpSearchInput}, '%') OR
            BINARY A.m_company Like CONCAT('%', #{searchEqpSearchInput}, '%') OR
            BINARY A.model Like CONCAT('%', #{searchEqpSearchInput}, '%')
            )
        </if>
    </sql>

    <select id="getEquipmentTotalList" parameterType="Map" resultType="Map">
        /* getEqpTotalList ...
            장비관리 > 장비목록 > 리스트 목록  */
        SELECT
            A.eqp_manage_id                   /* 장비 관리번호 */
            , A.eqp_name                      /* 장비명 */
            , A.host_name                     /* 호스트명 */
            , A.model_name                    /* 모델명 */
            , A.m_company                     /* 제조사 */
            , A.domestic                      /* 국산여부 */
            , A.redundancy_config             /* 이중화구성여부 */
            , A.maintenance_contract_target   /* 유지관리 계약대상여부 */
            , A.config_id                     /* 구성분류 */
            , A.asset_id                      /* 자산분류 */
            , A.sub_id                        /* 자산세부분류 */
            , A.detail_id                     /* 자산상세분류 */
            , A.network_operation_type        /* 네트워크 운영 구분 */
            , A.operating_status              /* 운영상태 */
            , A.operating_department          /* 운영부서 */
            , A.primary_operator              /* 운영담당자(정) */
            , A.secondary_operator            /* 운영담당자(부) */
            , A.primary_outsourced_operator   /* 위탁운영사용자(정) */
            , A.secondary_outsourced_operator /* 위탁운영사용자(부) */
            , A.created_at                    /* 생성일 */
            , A.updated_at                    /* 수정일 */
            , A.creator                       /* 등록자 */
        FROM equipment_basic A
        WHERE 1=1
        <include refid="getEquipmentTotalCommon"/>
        LIMIT #{offset},#{limit};
    </select>


    <select id="getEquipmentTotalListCnt" parameterType="Map" resultType="int">
        /* getEqpTotalListCnt ...
            장비관리 > 장비목록 > 리스트 개수  */
        SELECT
            COUNT(*)
        FROM
            equipment_basic A
        WHERE 1=1
        <include refid="getEquipmentTotalCommon"/>
    </select>

    <select id="getSelectConfigData" parameterType="map" resultType="map">
        /* getSelectConfigData
            장비관리 > 장비목록 > 추가/수정/상세 페이지 > 장비분류 > 구성분류 */
        select
            config_id as `id`, config_category as `name`
        from
            equipment_categories
        GROUP BY config_id;
    </select>

    <select id="getSelectAssetData" parameterType="map" resultType="map">
        /* getSelectAssetData
            장비관리 > 장비목록 > 추가/수정/상세 페이지 > 장비분류 > 자산분류 */
        select
            asset_id as `id`, asset_category as `name`
        from
            equipment_categories
        where
            config_id = #{id}
        group by asset_id;
    </select>

    <select id="getSelectSubData" parameterType="map" resultType="map">
        /* getSelectSubData
            장비관리 > 장비목록 > 추가/수정/상세 페이지 > 장비분류 > 자산세부분류 */
        select
            sub_id as `id`, sub_category as `name`, categories
        from
            equipment_categories
        where
            asset_id = #{id}
        GROUP BY sub_id;
    </select>

    <select id="getSelectDetailData" parameterType="map" resultType="map">
        /* getSelectDetailData
            장비관리 > 장비목록 > 추가/수정/상세 페이지 > 장비분류 > 자산상세분류 */
        select
            detail_id as `id`, detail_category as `name`
        from
            equipment_categories
        where
            sub_id = #{id}
        GROUP BY detail_id;
    </select>

    <select id="generateEqpManageId" parameterType="map" resultType="String">
        /* generateEqpManageId...
            장비관리 > 장비목록 > 추가 페이지 > 저장 > 장비 관리번호 생성
        */
        SELECT
            CONCAT(#{categories}, YEAR(CURDATE()), LPAD(IFNULL(MAX(CAST(SUBSTRING(eqp_manage_id, -4) AS UNSIGNED)) + 1, 1), 4, '0'))
        FROM
            equipment_basic
        WHERE eqp_manage_id LIKE CONCAT(#{categories}, YEAR(CURDATE()), '%');
    </select>

    <insert id="insertEquipmentBasic" parameterType="map">
        /* insertEquipmentBasic...
            장비관리 > 장비목록 > 추가 페이지 > 저장 > 장비 기본정보 저장
        */
        INSERT INTO equipment_basic (
            eqp_manage_id,
            eqp_name,
            host_name,
            model_name,
            m_company,
            domestic,
            redundancy_config,
            maintenance_contract_target,
            config_id,
            asset_id,
            sub_id,
            detail_id,
            network_operation_type,
            operating_status,
            operating_department,
            primary_operator,
            secondary_operator,
            primary_outsourced_operator,
            secondary_outsourced_operator,
            created_at,
            updated_at,
            creator,
            is_deleted
        )
        VALUES (
            #{eqp_manage_id},
            #{eqp_name},
            #{host_name},
            #{model_name},
            #{m_company},
            #{domestic},
            #{redundancy_config},
            #{maintenance_contract_target},
            #{config_id},
            #{asset_id},
            #{sub_id},
            #{detail_id},
            #{network_operation_type},
            #{operating_status},
            #{operating_department},
            #{primary_operator},
            #{secondary_operator},
            #{primary_outsourced_operator},
            #{secondary_outsourced_operator},
            NOW(),
            NULL,
            NULL,
            'N'
        )
    </insert>

    <insert id="insertEquipmentDetail" parameterType="map">
        /* insertEquipmentDetail...
            장비관리 > 장비목록 > 추가 페이지 > 저장 > 장비 세부정보 저장
        */
        insert into equipment_detail(
            eqp_manage_id,
            CPU,
            MEMORY,
            DISK,
            ip_address,
            OS,
            acquisition_cost,
            installation_coordinates,
            installation_units,
            equipment_size_units,
            dbrain_number,
            serial_number,
            asset_acquisition_date,
            asset_disposal_date,
            eol_status,
            eos_status
        )
        values(
            #{eqp_manage_id},
            #{cpu},
            #{mem},
            #{disk},
            #{ip_address},
            #{os_version},
            #{acquisition_cost},
            #{installation_coordinates},
            #{installation_units},
            #{equipment_size_units},
            #{dbrain_number},
            #{serial_number},
            #{asset_acquisition_date},
            #{asset_disposal_date},
            #{eol_status},
            #{eos_status}
        )
    </insert>

    <insert id="insertEquipmentPort" parameterType="map">
        /* insertEquipmentPort...
            장비관리 > 장비목록 > 추가 페이지 > 저장 > 장비 연결정보 저장
        */

    </insert>


    <select id="getEquipmentDetailTotalList" parameterType="String" resultType="map">
        /* getEquipmentDetailTotalList...
            장비관리 > 장비목록 > 수정 / 상세 페이지 > 장비 정보 (기본정보, 상세정보, 연결정보)
        */
        select
            eb.eqp_manage_id,
            eb.eqp_name,
            eb.host_name,
            eb.model_name,
            eb.m_company,
            eb.domestic,
            eb.redundancy_config,
            eb.maintenance_contract_target,
            eb.config_id,
            eb.asset_id,
            eb.sub_id,
            eb.detail_id,
            eb.network_operation_type,
            eb.operating_status,
            eb.operating_department,
            eb.primary_operator,
            eb.secondary_operator,
            eb.primary_outsourced_operator,
            eb.secondary_outsourced_operator,
            ed.CPU,
            ed.MEMORY,
            ed.DISK,
            ed.ip_address,
            ed.OS,
            ed.acquisition_cost,
            ed.installation_coordinates,
            ed.installation_units,
            ed.equipment_size_units,
            ed.dbrain_number,
            ed.serial_number,
            ed.asset_acquisition_date,
            ed.asset_disposal_date,
            ed.eol_status,
            ed.eos_status
        from equipment_basic eb
        join equipment_detail ed
            on eb.eqp_manage_id = ed.eqp_manage_id
        where 1=1
            and eb.eqp_manage_id = #{eqp_manage_id}
    </select>

    <select id="getEquipmentDetailAssetList" parameterType="map" resultType="map">
        /* getEquipmentDetailAssetList...
        장비관리 > 장비목록 > 상세 페이지 > 장비 정보 (기본정보의 장비 분류 카테고리)
        */
        select
            ec.config_category,
            ec.asset_category,
            ec.sub_category,
            ec.detail_category
        from
            equipment_basic eb
        join
            equipment_categories ec
            on eb.config_id = ec.config_id
            and eb.asset_id = ec.asset_id
            and eb.sub_id = ec.sub_id
            and eb.detail_id = ec.detail_id
        where 1=1
            and eb.eqp_manage_id = #{eqp_manage_id}
    </select>







    <!-- -->

    <update id="updateEqpList" parameterType="Map">
        /* updateEqpList ...
            장비관리 > 장비목록 > 수정 */
        UPDATE equipment
        SET
            eqp_name = #{eqp_name}
        <if test="config_category != null and config_category != ''">
            , config_category = #{config_category}
        </if>
        <if test="asset_id != null and asset_id != ''">
            , asset_id = #{asset_id}
        </if>
        <if test="m_company != null and m_company != ''">
            , m_company = #{m_company}
        </if>
        <if test="operating_department != null and operating_department != ''">
            , operating_department = #{operating_department}
        </if>
        <if test="primary_operator != null and primary_operator != ''">
            , primary_operator = #{primary_operator}
        </if>
        <if test="secondary_operator != null and secondary_operator != ''">
            , secondary_operator = #{secondary_operator}
        </if>
        <if test="primary_outsourced_operator != null and primary_outsourced_operator != ''">
            , primary_outsourced_operator = #{primary_outsourced_operator}
        </if>
        <if test="secondary_outsourced_operator != null and secondary_outsourced_operator != ''">
            , secondary_outsourced_operator = #{secondary_outsourced_operator}
        </if>
        <if test="maintenance_contract_target != null and maintenance_contract_target != ''">
            , maintenance_contract_target = #{maintenance_contract_target}
        </if>
        <if test="redundancy_config != null and redundancy_config != ''">
            , redundancy_config = #{redundancy_config}
        </if>
        <if test="domestic != null and domestic != ''">
            , domestic = #{domestic}
        </if>
        <if test="asset_category != null and asset_category != ''">
            , asset_category = #{asset_category}
        </if>
        <if test="config_id != null and config_id != ''">
            , config_id = #{config_id}
        </if>
        <if test="model != null and model != ''">
            , model = #{model}
        </if>
        <if test="operating_status != null and operating_status != ''">
            , operating_status = #{operating_status}
        </if>
        <if test="asset_acquisition_date != null and asset_acquisition_date != ''">
            , asset_acquisition_date = #{asset_acquisition_date}
        </if>
        <if test="asset_disposal_date != null and asset_disposal_date != ''">
            , asset_disposal_date = #{asset_disposal_date}
        </if>
        <if test="yearofintroduct != null and yearofintroduct != ''">
            , yearofintroduct = #{yearofintroduct}
        </if>
        <if test="acquisition_cost != null and acquisition_cost != ''">
            , acquisition_cost = #{acquisition_cost}
        </if>
        <if test="unit_position != null and unit_position != ''">
            , unit_position = #{unit_position}
        </if>
        <if test="dbrain_number != null and dbrain_number != ''">
            , dbrain_number = #{dbrain_number}
        </if>
        <if test="eol_status != null and eol_status != ''">
            , eol_status = #{eol_status}
        </if>
        <if test="eos_status != null and eos_status != ''">
            , eos_status = #{eos_status}
        </if>
        <if test="network_operation_type != null and network_operation_type != ''">
            , network_operation_type = #{network_operation_type}
        </if>
        <if test="hostname != null and hostname != ''">
            , hostname = #{hostname}
        </if>
        <if test="ip_address != null and ip_address != ''">
            , ip_address = #{ip_address}
        </if>
        <if test="serial_number != null and serial_number != ''">
            , serial_number = #{serial_number}
        </if>
        <if test="installation_coordinates != null and installation_coordinates != ''">
            , installation_coordinates = #{installation_coordinates}
        </if>
        <if test="installation_units != null and installation_units != ''">
            , installation_units = #{installation_units}
        </if>
        <if test="resource_name != null and resource_name != ''">
            , resource_name = #{resource_name}
        </if>
        <if test="os_version != null and os_version != ''">
            , os_version = #{os_version}
        </if>
        <if test="cpu != null and cpu != ''">
            , cpu = #{cpu}
        </if>
        <if test="mem != null and mem != ''">
            , mem = #{mem}
        </if>
        <if test="disk != null and disk != ''">
            , disk = #{disk}
        </if>
        <if test="equipment_size_units != null and equipment_size_units != ''">
            , equipment_size_units = #{equipment_size_units}
        </if>
        WHERE id = #{eqp_id};
    </update>

    <update id="deleteEqpList" parameterType="String">
        /* deleteEqpList ...
            장비관리 > 장비목록 > 삭제*/
        update equipment_basic
        set is_deleted = 'Y'
        where eqp_manage_id = #{deleteEqpTarget}
    </update>

</mapper>
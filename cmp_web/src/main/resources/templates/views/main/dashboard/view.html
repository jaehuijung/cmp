<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<head>
    <style>
        .dashboard-header {
            background-color: #e0e0e0;
            padding: 20px;
            text-align: center;
            font-size: 24px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .dashboard-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .dashboard-chart {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 100%;
            height: 100%;
            flex: 1 1 300px; /* 기본 너비 300px */
        }
        @media (min-width: 980px) and (max-width: 1800px) {
            .dashboard-chart {
                flex: 1 1 calc(50% - 40px); /* 너비 1/2 */
                max-width: calc(50% - 40px);
            }
        }
        @media (max-width: 970px) {
            .dashboard-chart {
                flex: 1 1 calc(100% - 40px); /* 너비 100% */
                max-width: calc(100% - 40px);
            }
        }
        /* Fixed widths and heights for responsive configuration */
        .size-1-4-500 { width: 500px; height: 500px; }
        .size-1-4-700 { width: 700px; height: 700px; }
        .size-2-2-600 { width: 600px; height: 600px; }
        .size-2-2-700 { width: 700px; height: 700px; }
        .size-2-2-800 { width: 800px; height: 800px; }
    </style>
</head>

<body>
<div layout:fragment="content">
    <main id="main" class="dashboard">
        <div class="dashboard-header">
            <span>Dashboard Overview</span>
        </div>

        <div class="dashboard-container">
            <div class="dashboard-chart" id="dashboard-chart1">
                <h4>광 케이블 포설 상세현황</h4>
                <hr>
                <div class="flex-even custom-margin-top-30">
                    <canvas id="fiberCableChart"></canvas>
                </div>
            </div>
            <div class="dashboard-chart" id="dashboard-chart2">
                <h4>UTF 케이블 포설 상세현황</h4>
                <hr>
                <div class="flex-even custom-margin-top-30">
                    <canvas id="utpCableChart"></canvas>
                </div>
            </div>
            <div class="dashboard-chart" id="dashboard-chart3">
                <h4>장비 등록 상세현황</h4>
                <hr>
                <div class="flex-even custom-margin-top-30">
                    <canvas id="equipmentChart"></canvas>
                </div>
            </div>
            <div class="dashboard-chart" id="dashboard-chart4">
                <h4>소프트웨어 등록 상세현황</h4>
                <hr>
                <div class="flex-even custom-margin-top-30">
                    <canvas id="softwareChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <th:block layout:fragment="script">
        <script th:src="@{/js/main/dashboard/view.js}"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
        <script th:inline="javascript">
            const fiberCableData = /*[[${fiberCableData}]]*/;
            const fiberDetailFilterData = fiberCableData.filter(item => item.speed !== 'total');
            const fiberDetailLabels = fiberDetailFilterData.map(item => item.speed);
            const fiberDetailValues = fiberDetailFilterData.map(item => item.cnt);

            const utpCableData  = /*[[${utpCableData}]]*/;
            const utpDetailFilterData = utpCableData.filter(item => item.speed !== 'total');
            const utpDetailLabels = utpDetailFilterData.map(item => item.speed);
            const utpDetailValues = utpDetailFilterData.map(item => item.cnt);

            const hardwareData  = /*[[${hardwareData}]]*/;
            const hwDetailFilterData = hardwareData.filter(item => item.asset !== 'total');
            const hwDetailLabels = hwDetailFilterData.map(item => item.asset);
            const hwDetailValues = hwDetailFilterData.map(item => item.cnt);

            const softwareData  = /*[[${softwareData}]]*/;
            const swDetailFilterData = softwareData.filter(item => item.asset !== 'total');
            const swDetailLabels = swDetailFilterData.map(item => item.asset);
            const swDetailValues = swDetailFilterData.map(item => item.cnt);

        </script>

        <script>
            let fiberCableChart, utpCableChart, equipmentChart, softwareChart;

            // 최대 데이터값 계산 함수
            function getMaxDataValue(data) {
                return Math.max(...data);
            }

            // 동적으로 stepSize를 설정하는 함수
            function calculateStepSize(maxValue) {
                const stepBase = Math.pow(10, Math.floor(Math.log10(maxValue / 10)));
                return stepBase;
            }

            // 공통 옵션 함수
            function createChartOptions(data) {
                const maxDataValue = getMaxDataValue(data);
                const stepSize = calculateStepSize(maxDataValue);
                const maxTicksValue = Math.ceil(maxDataValue / stepSize) * stepSize + (stepSize * 3);

                return {
                    plugins: {
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            color: 'rgba(0, 0, 0, 0.7)',
                            font: {
                                weight: 'bold'
                            },
                        },
                        legend: { // 라벨 제거
                            display: false
                        },
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: maxTicksValue,
                            ticks: {
                                stepSize: stepSize
                            }
                        }
                    }
                };
            }

            // 차트 생성 함수
            function createCharts() {
                // 기존 차트가 있다면 모두 제거
                if (fiberCableChart) fiberCableChart.destroy();
                if (utpCableChart) utpCableChart.destroy();
                if (equipmentChart) equipmentChart.destroy();
                if (softwareChart) softwareChart.destroy();

                // fiberCableChart 생성
                fiberCableChart = new Chart(document.getElementById('fiberCableChart').getContext('2d'), {
                    type: 'bar', // 막대그래프 타입 지정
                    data: {
                        labels: fiberDetailLabels,
                        datasets: [{
                            data: fiberDetailValues,
                            backgroundColor: [
                                'rgba(75, 192, 192, 0.2)', // Cyan color
                                'rgba(153, 102, 255, 0.2)', // Purple color
                                'rgba(255, 159, 64, 0.2)'   // Orange color
                            ],
                            borderColor: [
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: createChartOptions(fiberDetailValues),
                    plugins: [ChartDataLabels]
                });

                // utpCableChart 생성
                utpCableChart = new Chart(document.getElementById('utpCableChart').getContext('2d'), {
                    type: 'bar', // 막대그래프 타입 지정
                    data: {
                        labels: utpDetailLabels,
                        datasets: [{
                            data: utpDetailValues,
                            backgroundColor: [
                                'rgba(75, 192, 192, 0.2)', // Cyan color
                                'rgba(153, 102, 255, 0.2)', // Purple color
                                'rgba(255, 159, 64, 0.2)'   // Orange color
                            ],
                            borderColor: [
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: createChartOptions(utpDetailValues),
                    plugins: [ChartDataLabels]
                });

                // equipmentChart 생성
                equipmentChart = new Chart(document.getElementById('equipmentChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: hwDetailLabels,
                        datasets: [{
                            data: hwDetailValues,
                            backgroundColor: [
                                'rgba(75, 192, 192, 0.2)', // Cyan color
                                'rgba(153, 102, 255, 0.2)', // Purple color
                                'rgba(255, 159, 64, 0.2)'   // Orange color
                            ],
                            borderColor: [
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: createChartOptions(hwDetailValues),
                    plugins: [ChartDataLabels]
                });

                // softwareChart 생성
                softwareChart = new Chart(document.getElementById('softwareChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: swDetailLabels,
                        datasets: [{
                            data: swDetailValues,
                            backgroundColor: [
                                'rgba(75, 192, 192, 0.2)', // Cyan color
                                'rgba(153, 102, 255, 0.2)', // Purple color
                                'rgba(255, 159, 64, 0.2)'   // Orange color
                            ],
                            borderColor: [
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: createChartOptions(swDetailValues),
                    plugins: [ChartDataLabels]
                });
            }

            $(function(){
                // 최초 차트 생성
                createCharts();

                // 창 크기 변경 시 차트 재생성
                $(window).resize(function() {
                    createCharts();
                });
            });
        </script>

    </th:block>
</div>
</body>
</html>
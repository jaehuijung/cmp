<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<head>
    <style>
        .cable-info {
            text-align: left;
            font-size: 16px;
            margin-top: 20px;
        }

        .cable-info div canvas {
            flex-grow: 1;
            align-self: center;
            margin-left: 10px;
        }
    </style>
</head>

<body>
<div layout:fragment="content">

    <main id="main" class="dashboard">
        <div class="flex-wrap-center">
            <div class="contentCard custom-width-550 custom-margin-10 custom-padding-20">
                <div class="custom-font-size-22 custom-font-weight-500 custom-margin-bottom-20">케이블 포설 현황</div>
                <div class="flex-end custom-width-350">
                    <canvas id="chartCable" width="300" height="300"></canvas>
                    <div class="flex-column margin-bottom-10" id="cableInfo"></div>
                </div>

            </div>
        </div>
    </main>

    <th:block layout:fragment="script">
        <script th:src="@{/js/main/dashboard/view.js}"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                // 쿼리 결과를 위한 예시 데이터
                const cableData = {
                    광: 35,
                    UTF: 21,
                    TOTAL: 56
                };

                // 백분율 계산 함수
                function calculatePercentage(value, total) {
                    return ((value / total) * 100).toFixed(2) + '%';
                }

                // 케이블 포설 현황 차트
                new Chart(document.getElementById('chartCable'), {
                    type: 'pie',
                    data: {
                        labels: ['광', 'UTF'],
                        datasets: [{
                            data: [cableData.광, cableData.UTF],
                            backgroundColor: ['#4CAF50', '#FFC107'],   // 색상 변경
                        }]
                    },
                    options: {
                        plugins: {
                            datalabels: {
                                formatter: (value, context) => {
                                    return context.chart.data.labels[context.dataIndex] + '\n' + value;
                                },
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 22
                                },
                                formatter: function(value, context) {
                                    return context.chart.data.labels[context.dataIndex] + '\n' + calculatePercentage(value, cableData.TOTAL);
                                }
                            },
                            legend: {
                                display: false // 라벨 제거
                            },
                        },
                        interaction: {
                            mode: null // 호버 비활성화
                        }
                    },
                    plugins: [ChartDataLabels] // 내부 라벨을 표시하기 위해 플러그인 추가
                });

                // 텍스트와 선 추가
                const cableInfo = document.getElementById('cableInfo');

                // 광 텍스트와 캔버스 추가
                let div = document.createElement('div');
                div.innerHTML = '광 ' + cableData.광 + '개';
                let canvas = document.createElement('canvas');
                canvas.id = 'line1';
                div.appendChild(canvas);
                cableInfo.appendChild(div);

                // UTP 텍스트와 캔버스 추가
                div = document.createElement('div');
                div.innerHTML = 'UTP ' + cableData.UTF + '개';
                canvas = document.createElement('canvas');
                canvas.id = 'line2';
                div.appendChild(canvas);
                cableInfo.appendChild(div);

                // TOTAL 텍스트와 캔버스 추가
                div = document.createElement('div');
                div.innerHTML = '계 ' + cableData.TOTAL + '개';
                canvas = document.createElement('canvas');
                canvas.id = 'line3';
                div.appendChild(canvas);
                cableInfo.appendChild(div);

                // 선 그리기
                drawLine('line1');
                drawLine('line2');
                drawLine('line3');
            });

            function drawLine(canvasId) {
                var canvas = document.getElementById(canvasId);
                if (canvas.getContext) {
                    var ctx = canvas.getContext('2d');
                    canvas.width = 100; // 캔버스 너비 설정
                    canvas.height = 20; // 캔버스 높이 설정
                    ctx.beginPath();
                    ctx.moveTo(0, 10);
                    ctx.lineTo(canvas.width, 10);
                    ctx.stroke();
                }
            }
        </script>
    </th:block>

</div>
</body>

</html>